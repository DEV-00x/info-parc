{% extends "layout.html" %}
{% block content %}
<div class="container-fluid px-0">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Accueil</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('devices') }}">Appareils</a></li>
            <li class="breadcrumb-item active text-truncate">{{ device.name }}</li>
        </ol>
    </nav>

    <!-- Device Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm border-0 bg-gradient-primary text-white">
                <div class="card-body py-3 py-md-4">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                        <div class="d-flex align-items-center mb-3 mb-md-0">
                            <div class="device-icon-large me-3 me-md-4 rounded-circle bg-white p-2 p-md-3">
                                {% if device.type == 'ordinateur de bureau' %}
                                    <i class="fas fa-desktop fa-2x text-primary"></i>
                                {% elif device.type == 'ordinateur portable' %}
                                    <i class="fas fa-laptop fa-2x text-primary"></i>
                                {% elif device.type == 'imprimante' %}
                                    <i class="fas fa-print fa-2x text-primary"></i>
                                {% elif device.type == 'scanner' %}
                                    <i class="fas fa-scanner fa-2x text-primary"></i>
                                {% elif device.type == 'routeur' %}
                                    <i class="fas fa-network-wired fa-2x text-primary"></i>
                                {% elif device.type == 'switch' %}
                                    <i class="fas fa-ethernet fa-2x text-primary"></i>
                                {% elif device.type == 'serveur' %}
                                    <i class="fas fa-server fa-2x text-primary"></i>
                                {% else %}
                                    <i class="fas fa-hdd fa-2x text-primary"></i>
                                {% endif %}
                            </div>
                            <div>
                                <h2 class="mb-0 fw-bold fs-4 fs-md-2">{{ device.name }}</h2>
                                <p class="text-white-50 mb-0 fs-6 fs-md-5">
                                    {{ device.type|capitalize }} | 
                                    <span class="badge bg-{{ 'success' if device.status == 'actif' else 'warning' if device.status == 'en maintenance' else 'danger' }} fs-6">
                                        {{ device.status|upper }}
                                    </span>
                                </p>
                            </div>
                        </div>
                        <div class="action-buttons d-flex flex-wrap gap-2 w-100 w-md-auto justify-content-start justify-content-md-end">
                            <a href="{{ url_for('edit_device', device_id=device.id) }}" class="btn btn-light btn-sm btn-md-normal">
                                <i class="fas fa-edit me-1"></i> Modifier
                            </a>
                            <a href="{{ url_for('add_maintenance', device_id=device.id) }}" class="btn btn-warning btn-sm btn-md-normal">
                                <i class="fas fa-tools me-1"></i> Maintenance
                            </a>
                            <a href="{{ url_for('delete_device', device_id=device.id) }}" class="btn btn-danger btn-sm btn-md-normal" onclick="return confirmDelete(event, 'Êtes-vous sûr de vouloir supprimer cet appareil?')">
                                <i class="fas fa-trash-alt me-1"></i> Supprimer
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="deviceTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab" aria-controls="info" aria-selected="true">
                <i class="fas fa-info-circle me-1"></i> Informations
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance" type="button" role="tab" aria-controls="maintenance" aria-selected="false">
                <i class="fas fa-tools me-1"></i> Maintenance
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ownership-tab" data-bs-toggle="tab" data-bs-target="#ownership" type="button" role="tab" aria-controls="ownership" aria-selected="false">
                <i class="fas fa-exchange-alt me-1"></i> Historique des Propriétaires
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="deviceTabsContent">
        <!-- Info Tab -->
        <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
            <div class="row">
                <!-- Device Details -->
                <div class="col-md-12 mb-4">
                    <!-- Device Information Card -->
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white py-2 py-md-3">
                            <h5 class="mb-0 d-flex align-items-center">
                                <span class="icon-circle bg-primary text-white me-2">
                                    <i class="fas fa-info-circle"></i>
                                </span>
                                Informations de l'Appareil
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-2 g-md-3">
                                <div class="col-12 col-sm-6">
                                    <div class="info-group mb-2 mb-md-3 p-2 border-start border-primary border-3 bg-light">
                                        <div class="text-muted small">Nom</div>
                                        <div class="fw-bold text-break">{{ device.name }}</div>
                                    </div>
                                    
                                    <div class="info-group mb-2 mb-md-3 p-2 border-start border-primary border-3 bg-light">
                                        <div class="text-muted small">Type</div>
                                        <div class="fw-bold">{{ device.type|capitalize }}</div>
                                    </div>
                                    
                                    <div class="info-group mb-2 mb-md-3 p-2 border-start border-primary border-3 bg-light">
                                        <div class="text-muted small">Numéro de Série</div>
                                        <div class="fw-bold text-break">{{ device.serial_number }}</div>
                                    </div>
                                    
                                    <div class="info-group mb-2 mb-md-3 p-2 border-start border-primary border-3 bg-light">
                                        <div class="text-muted small">Statut</div>
                                        <div>
                                            <span class="badge bg-{{ 'success' if device.status == 'actif' else 'warning' if device.status == 'en maintenance' else 'secondary' }}">
                                                {{ device.status }}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="info-group mb-2 mb-md-3 p-2 border-start border-primary border-3 bg-light">
                                        <div class="text-muted small">Service</div>
                                        <div class="fw-bold">{{ device.service or '-' }}</div>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="info-group mb-2 mb-md-3 p-2 border-start border-primary border-3 bg-light">
                                        <div class="text-muted small">Département</div>
                                        <div class="fw-bold">{{ device.department or '-' }}</div>
                                    </div>
                                    
                                    <div class="info-group mb-2 mb-md-3 p-2 border-start border-primary border-3 bg-light">
                                        <div class="text-muted small">Responsable</div>
                                        <div class="fw-bold d-flex align-items-center flex-wrap">
                                            {% if device.owner %}
                                                <span class="text-break me-1">{{ device.owner }}</span>
                                                <a href="{{ url_for('devices_by_owner', owner=device.owner) }}" class="text-primary" data-bs-toggle="tooltip" title="Voir tous les appareils de ce responsable">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="info-group mb-2 mb-md-3 p-2 border-start border-primary border-3 bg-light">
                                        <div class="text-muted small">Assigné à</div>
                                        <div class="fw-bold d-flex align-items-center flex-wrap">
                                            {% if device.assigned_to %}
                                                <span class="text-break me-1">{{ device.assigned_to }}</span>
                                                <a href="{{ url_for('devices_by_assigned', assigned_to=device.assigned_to) }}" class="text-primary" data-bs-toggle="tooltip" title="Voir tous les appareils assignés à cette personne">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="info-group mb-2 mb-md-3 p-2 border-start border-primary border-3 bg-light">
                                        <div class="text-muted small">Adresse MAC</div>
                                        <div class="fw-bold text-break">{{ device.mac_address or '-' }}</div>
                                    </div>
                                    
                                    <div class="info-group mb-2 mb-md-3 p-2 border-start border-primary border-3 bg-light">
                                        <div class="text-muted small">Notes</div>
                                        <div class="fw-bold text-break">{{ device.notes or '-' }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Maintenance Tab -->
        <div class="tab-pane fade" id="maintenance" role="tabpanel" aria-labelledby="maintenance-tab">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-2 py-md-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 d-flex align-items-center">
                        <span class="icon-circle bg-primary text-white me-2">
                            <i class="fas fa-history"></i>
                        </span>
                        Historique de Maintenance
                    </h5>
                    <a href="{{ url_for('add_maintenance', device_id=device.id) }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus-circle me-1"></i> Ajouter
                    </a>
                </div>
                <div class="card-body p-0">
                    {% if maintenance_records %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0">Date</th>
                                    <th class="border-0">Description</th>
                                    <th class="border-0">Statut</th>
                                    <th class="border-0">Technicien</th>
                                    <th class="border-0 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in maintenance_records %}
                                <tr>
                                    <td>{{ record.maintenance_date.strftime('%d/%m/%Y') }}</td>
                                    <td class="text-truncate" style="max-width: 150px;">{{ record.description }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'info' if record.status == 'en attente' else 'warning' if record.status == 'en cours' else 'success' }}">
                                            {{ record.status }}
                                        </span>
                                    </td>
                                    <td>{{ record.technician or '-' }}</td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('view_maintenance', maintenance_id=record.id) }}" class="btn btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('edit_maintenance', maintenance_id=record.id) }}" class="btn btn-outline-secondary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{{ url_for('delete_maintenance', maintenance_id=record.id) }}" class="btn btn-outline-danger" onclick="return confirmDelete(event, 'Êtes-vous sûr de vouloir supprimer cet enregistrement de maintenance?')">
                                                <i class="fas fa-trash-alt"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="mb-3">
                            <i class="fas fa-tools fa-3x text-muted"></i>
                        </div>
                        <h6 class="text-muted">Aucun enregistrement de maintenance trouvé</h6>
                        <p class="small text-muted">Ajoutez un nouvel enregistrement de maintenance pour cet appareil</p>
                        <a href="{{ url_for('add_maintenance', device_id=device.id) }}" class="btn btn-primary btn-sm mt-2">
                            <i class="fas fa-plus-circle me-1"></i> Ajouter une Maintenance
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Ownership History Tab -->
        <div class="tab-pane fade" id="ownership" role="tabpanel" aria-labelledby="ownership-tab">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0 d-flex align-items-center">
                        <span class="icon-circle bg-primary text-white me-2">
                            <i class="fas fa-exchange-alt"></i>
                        </span>
                        Historique des Changements de Propriétaire
                    </h5>
                    <a href="{{ url_for('ownership_history', device_id=device.id) }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus-circle me-1"></i> Ajouter
                    </a>
                </div>
                <div class="card-body p-0">
                    {% if device.ownership_changes %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="border-0">Date</th>
                                        <th class="border-0">Ancien Propriétaire</th>
                                        <th class="border-0">Nouveau Propriétaire</th>
                                        <th class="border-0">Notes</th>
                                        <th class="border-0 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for change in device.ownership_changes|sort(attribute='change_date', reverse=True) %}
                                    <tr>
                                        <td>{{ change.change_date.strftime('%d/%m/%Y %H:%M') }}</td>
                                        <td>{{ change.previous_owner or '-' }}</td>
                                        <td>{{ change.new_owner or '-' }}</td>
                                        <td class="text-truncate" style="max-width: 150px;">{{ change.notes or '-' }}</td>
                                        <td class="text-center">
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ url_for('ownership_history', device_id=device.id, change_id=change.id) }}" class="btn btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="{{ url_for('ownership_history', device_id=device.id, change_id=change.id, action='edit') }}" class="btn btn-outline-secondary">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a href="{{ url_for('ownership_history', device_id=device.id, change_id=change.id, action='delete') }}" class="btn btn-outline-danger" onclick="return confirmDelete(event, 'Êtes-vous sûr de vouloir supprimer cet enregistrement de changement de propriétaire?')">
                                                    <i class="fas fa-trash-alt"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <i class="fas fa-exchange-alt fa-3x text-muted"></i>
                            </div>
                            <h6 class="text-muted">Aucun changement de propriétaire enregistré</h6>
                            <p class="small text-muted">Ajoutez un nouvel enregistrement de changement de propriétaire pour cet appareil</p>
                            <a href="{{ url_for('ownership_history', device_id=device.id) }}" class="btn btn-primary btn-sm mt-2">
                                <i class="fas fa-plus-circle me-1"></i> Ajouter un Changement
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @media (max-width: 768px) {
        .nav-tabs {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            -ms-overflow-style: -ms-autohiding-scrollbar;
            margin-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 1px;
        }
        
        .nav-tabs .nav-item {
            flex: 0 0 auto;
            white-space: nowrap;
        }
        
        .nav-tabs .nav-link {
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }
        
        .device-icon-large {
            width: 50px;
            height: 50px;
        }
        
        .device-icon-large i {
            font-size: 1.5rem !important;
        }
        
        .icon-circle {
            width: 32px;
            height: 32px;
            min-width: 32px;
        }
        
        .card-header h5 {
            font-size: 1rem;
        }
        
        .info-group {
            font-size: 0.9rem;
        }
        
        .btn-md-normal {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .table th, .table td {
            padding: 0.5rem;
            font-size: 0.875rem;
        }
        
        .btn-group-sm .btn {
            padding: 0.2rem 0.4rem;
        }
        
        .btn-group-sm .btn i {
            font-size: 0.8rem;
        }
    }
    
    @media (max-width: 576px) {
        .nav-tabs .nav-link {
            padding: 0.4rem 0.6rem;
            font-size: 0.8rem;
        }
        
        .device-icon-large {
            width: 40px;
            height: 40px;
            padding: 0.5rem !important;
        }
        
        .device-icon-large i {
            font-size: 1.2rem !important;
        }
        
        .icon-circle {
            width: 28px;
            height: 28px;
            min-width: 28px;
        }
        
        .icon-circle i {
            font-size: 0.8rem;
        }
        
        .action-buttons {
            margin-top: 0.5rem;
        }
        
        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .card-header h5 {
            font-size: 0.9rem;
        }
        
        .info-group {
            font-size: 0.8rem;
            padding: 0.5rem !important;
        }
        
        .text-truncate {
            max-width: 100px !important;
        }
        
        .table th, .table td {
            padding: 0.4rem;
            font-size: 0.8rem;
        }
        
        .btn-group-sm .btn {
            padding: 0.15rem 0.3rem;
        }
        
        .btn-group-sm .btn i {
            font-size: 0.7rem;
        }
    }
    
    /* Add floating action button for mobile */
    @media (max-width: 768px) {
        .device-maintenance-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1030;
            display: block;
        }
    }
    
    /* Fix for text overflow */
    .text-break {
        word-break: break-word !important;
        overflow-wrap: break-word !important;
    }
    
    /* Improve tab scrolling indicator */
    .nav-tabs::-webkit-scrollbar {
        height: 3px;
    }
    
    .nav-tabs::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .nav-tabs::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }
    
    .nav-tabs::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add swipe notice for tables on mobile
        if (window.innerWidth < 768) {
            const tables = document.querySelectorAll('.table-responsive');
            tables.forEach(table => {
                if (!table.querySelector('.swipe-notice')) {
                    const notice = document.createElement('div');
                    notice.className = 'swipe-notice small text-muted text-center py-1 d-md-none';
                    notice.innerHTML = '<i class="fas fa-hand-point-right me-1"></i> Faites glisser pour voir plus';
                    table.parentNode.insertBefore(notice, table);
                }
            });
            
            // Add scroll indicator for tabs
            const tabsNav = document.querySelector('.nav-tabs');
            if (tabsNav) {
                const tabsContainer = tabsNav.parentElement;
                const scrollIndicator = document.createElement('div');
                scrollIndicator.className = 'small text-muted text-center d-md-none mt-1';
                scrollIndicator.innerHTML = '<i class="fas fa-arrow-right me-1"></i> Faites glisser pour voir plus d\'onglets';
                
                // Only show the indicator if tabs are overflowing
                if (tabsNav.scrollWidth > tabsNav.clientWidth) {
                    tabsContainer.insertBefore(scrollIndicator, tabsNav.nextSibling);
                }
                
                // Remove indicator when no longer needed
                tabsNav.addEventListener('scroll', function() {
                    if (Math.abs(tabsNav.scrollWidth - tabsNav.clientWidth - tabsNav.scrollLeft) < 10) {
                        scrollIndicator.style.display = 'none';
                    } else {
                        scrollIndicator.style.display = 'block';
                    }
                });
            }
        }
        
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    });
</script>
{% endblock %}